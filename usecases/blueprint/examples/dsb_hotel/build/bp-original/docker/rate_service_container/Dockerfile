# syntax=docker/dockerfile:1

#####
# Auto-generated Dockerfile for process workspace rate_service_container
#   Dockerfile auto-generated by linuxcontainer plugin
#   Code generation located at linuxcontainer/linuxgen/dockerfilegen.go
#

###
# Step 1: run custom commands provided by processes
###



####### BEGIN
#  custom docker build commands provided by goproc.Process rate_service_process
#

FROM golang:1.22-bookworm AS rate_service_process

COPY ./rate_service_process /src

WORKDIR /src
RUN go mod download

RUN mkdir /rate_service_process
RUN go build -o /rate_service_process ./rate_service_process

#
# custom docker build commands provided by goproc.Process rate_service_process
######## END





###
# Step 2: prepare the final image
###

# uView : we use cc-debian12 and not base-debian12 to have stdlib for FIRM C++ code
FROM gcr.io/distroless/cc-debian12

# uView: Copy artifacts for processes with custom build commands
COPY --from=firm-build /anomaly /anomaly

# Copy artifacts for processes that didn't have custom build commands


# Copy artifacts for processes with custom build commands
COPY --from=rate_service_process /rate_service_process /rate_service_process



# uView : PATH and dynamic libraries paths
ENV LD_LIBRARY_PATH="/anomaly/lib"
ENV PATH="/anomaly/bin:${PATH}"

# Get a shell
COPY --from=busybox:1.35.0-uclibc /bin/sh /bin/sh

# Copy the build.sh file and run it
WORKDIR /
COPY ./build.sh /
RUN ["/bin/sh", "./build.sh"]

# Copy the run.sh file and configure the entrypoint
WORKDIR /
COPY ./run.sh /
ENTRYPOINT ["bin/sh", "./run.sh"]
